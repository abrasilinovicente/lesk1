# =================================================================
# Arquivo de ConfiguraÃ§Ã£o Otimizado para Postfix (main.cf)
# v4.1 - Corrigido, Seguro e com Foco em IPv4
# =================================================================

# --- ConfiguraÃ§Ãµes Gerais ---
smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)
smtp_address_preference = ipv4
biff = no
append_dot_mydomain = no
readme_directory = no
recipient_delimiter = +
mailbox_size_limit = 0

# --- ConfiguraÃ§Ãµes de Identidade do Servidor ---
# A linha abaixo serÃ¡ substituÃ­da pelo seu domÃ­nio real atravÃ©s do script teste.sh
myhostname = seudominio.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = $myhostname, localhost.$mydomain, localhost
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
relayhost =

# --- ConfiguraÃ§Ãµes de Rede ---
# ADICIONADO: ForÃ§a o Postfix a usar apenas IPv4 para evitar problemas de conectividade.
inet_interfaces = all
inet_protocols = ipv4

# --- ConfiguraÃ§Ãµes de Relay e RestriÃ§Ãµes (CORRIGIDO) ---
# A linha abaixo corrige o erro fatal e define uma polÃ­tica de relay segura.
smtpd_relay_restrictions =
    permit_mynetworks
    permit_sasl_authenticated
    defer_unauth_destination
    reject_unauth_destination

# --- ConfiguraÃ§Ãµes de TLS (MELHORADO) ---
# Usa os certificados reais do Let's Encrypt instalados pelo Certbot.
smtpd_use_tls = yes
smtpd_tls_cert_file = /etc/letsencrypt/live/seudominio.com/fullchain.pem
smtpd_tls_key_file = /etc/letsencrypt/live/seudominio.com/privkey.pem
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache


smtp_tls_security_level = may
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# --- INTEGRAÃ‡ÃƒO COM OPENDKIM ---
# Conecta o Postfix ao OpenDKIM.
milter_protocol = 2
milter_default_action = accept
smtpd_milters = inet:localhost:8891
non_smtpd_milters = $smtpd_milters
